!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define("@kb1rd/logootish-js",[],e):"object"==typeof exports?exports["@kb1rd/logootish-js"]=e():t["@kb1rd/logootish-js"]=e()}("undefined"!=typeof self?self:this,(function(){return function(t){var e={};function r(n){if(e[n])return e[n].exports;var o=e[n]={i:n,l:!1,exports:{}};return t[n].call(o.exports,o,o.exports,r),o.l=!0,o.exports}return r.m=t,r.c=e,r.d=function(t,e,n){r.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:n})},r.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},r.t=function(t,e){if(1&e&&(t=r(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var n=Object.create(null);if(r.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var o in t)r.d(n,o,function(e){return t[e]}.bind(null,o));return n},r.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return r.d(e,"a",e),e},r.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},r.p="",r(r.s=3)}([function(t,e,r){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const n=r(1);e.Comparable=n.Comparable,e.arraymap=function(t,e){for(let r=0;r<t.length;){const n=e(t[r]);t.splice(r,1,...n),r+=n.length?n.length:1}return t};class o extends Error{constructor(){super(...arguments),this.fatal=!0}}e.FatalError=o;function s(t){return Object.keys(t).concat(Object.getOwnPropertySymbols(t))}e.MemberPtr=class{constructor(t,e){this.obj=t,this.key=e}get value(){return this.obj[this.key]}set value(t){this.obj[this.key]=t}},e.allKeys=s,e.allValues=function(t){return s(t).map(e=>t[e])};const i={};e.BreakException=i,e.catchBreak=function(t){try{t()}catch(t){if(t!==i)throw t}}},function(t,e,r){"use strict";function n(t){if(isNaN(t)||null==t)throw new TypeError(`Invalid compare result '${t}.'`);return t>0?1:t<0?-1:0}Object.defineProperty(e,"__esModule",{value:!0}),e.cmpResult=n;e.Comparable=class{gt(t){return 1===this.cmp(t)}gteq(t){return this.cmp(t)>=0}eq(t){return 0===this.cmp(t)}lteq(t){return this.cmp(t)<=0}lt(t){return-1===this.cmp(t)}};class o{constructor(t,e){!0===t||!1===t?(this.closed_left=t,this.closed_right=Boolean(e)):t[0]&&t[1]?(this.closed_left="["===t[0],this.closed_right="]"===t[1]):(this.closed_left=!0,this.closed_right=!0)}get left_str(){return this.closed_left?"[":"("}get right_str(){return this.closed_right?"]":")"}toString(){return this.left_str+this.right_str}}e.RangeBounds=o,o.LCGC=new o(!0,!0),o.LOGO=new o(!1,!1),o.LCGO=new o(!0,!1),o.LOGC=new o(!1,!0);class s{constructor(t,e,r,n=o.LCGC){this.cf=t,this.min=e,this.max=r,this.bounds=n}static gt(t,e){return new s(t,e,void 0,new o(!1,!1))}static gteq(t,e){return new s(t,e,void 0,new o(!0,!1))}static lt(t,e){return new s(t,void 0,e,new o(!1,!1))}static lteq(t,e){return new s(t,void 0,e,new o(!1,!0))}static all(t){return new s(t,void 0,void 0,new o(!1,!1))}get undef_min(){return void 0===this.min||null===this.min||NaN===this.min||this.min===-1/0}get def_min(){return!this.undef_min}get undef_max(){return void 0===this.max||null===this.max||NaN===this.max||this.max===1/0}get def_max(){return!this.undef_max}bound_def(t){return"min"===t?this.def_min:this.def_max}bound_undef(t){return"min"===t?this.undef_min:this.undef_max}contains(t){return(!this.min||this.cf(t,this.min)>=(this.bounds.closed_left?0:1))&&(!this.max||this.cf(this.max,t)>=(this.bounds.closed_right?0:1))}getRangeSection(t){return this.def_max&&this.cf(this.max,t)<(this.bounds.closed_right?0:1)?1:this.def_min&&this.cf(t,this.min)<(this.bounds.closed_left?0:1)?-1:0}compareEndpoints(t,e,r){if(this.bound_def(t)&&e.bound_undef(r))return"min"===r?1:-1;if(this.bound_undef(t)&&e.bound_undef(r))return t!==r?"max"===t?1:-1:0;if(this.bound_undef(t)&&e.bound_def(r))return"max"===t?1:-1;const n=this.cf(this[t],e[r]);if(0===n){const n="min"===t?!this.bounds.closed_left:this.bounds.closed_right,o="min"===r?!e.bounds.closed_left:e.bounds.closed_right;if(n&&!o)return 1;if(!n&&o)return-1}return n}doesContainInRange(t){return this.compareEndpoints("min",t,"min")<=0&&this.compareEndpoints("max",t,"max")>=0}mayContainInRange(t){return this.compareEndpoints("min",t,"max")<0&&this.compareEndpoints("max",t,"min")>0}toString(){return`${this.bounds.left_str}${this.min},${this.max}${this.bounds.right_str}`}}e.TypeRange=s;e.ComparableTypeRange=class extends s{constructor(t,e,r){super((t,e)=>t.cmp(e),t,e,r)}};e.NumberRange=class extends s{constructor(t,e,r){super((t,e)=>n(t-e),t,e,r)}push_offset(t){this.min+=t,this.max+=t}pop_offset(t){this.min-=t,this.max-=t}}},function(t,e,r){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const n=r(0);class o{constructor(t){this.data=t}}e.BstNode=o;class s{constructor(t){this.range=t,this.buckets={lesser:[],range:[],greater:[]}}addToBucket(t,e,r){this.buckets[t].push([e,r])}setBucket(t,e,r){let n;this.buckets[t].length&&0!==(n=this.range.cf(e,this.buckets[t][0][0]))?"lesser"===t&&n>0?this.buckets.lesser=[[e,r]]:"greater"===t&&n<0&&(this.buckets.greater=[[e,r]]):this.buckets[t].push([e,r])}}class i{constructor(t){this.lesser_find_greatest=!1,this.greater_find_least=!1,this.points=[],this.cf=t}static lteq(t,e,r){const n=new i(t);return n.points.push([e,!0,r]),n.last_bucket=void 0,n}static lt(t,e,r){const n=new i(t);return n.points.push([e,!1,r]),n.last_bucket=void 0,n}static gteq(t,e,r){const n=new i(t);return n.points.push([e,!1,void 0]),n.last_bucket=r,n}static gt(t,e,r){const n=new i(t);return n.points.push([e,!0,void 0]),n.last_bucket=r,n}push_point(t,e,r=!1){const n=[t,r,e];for(let e=0;e<this.points.length;e++)if(this.cf(t,this.points[e][0])<0)return void this.points.splice(e,0,n);this.points.push(n)}all_greater(t){this.last_bucket=t}getBucketInfo(t,e,r=!1,n){let o=!1,s=!1,i=this.last_bucket,l=Boolean(this.last_bucket);!this.points.length&&this.last_bucket&&(!o&&n&&n(),o=!0);for(let a=0;a<this.points.length;a++){const[h,c,u]=this.points[a];u&&!s&&(!o&&n&&n(),o=!0),this.cf(t,h)<(c?1:0)&&(s||(s=!0,i=u),0==a&&this.lesser_find_greatest&&r&&e[u]&&e[u].length&&(this.cf(e[u][0],t)<0?e[u]=[]:this.cf(e[u][0],t)>0&&(i=void 0))),u&&s&&0!==this.cf(h,t)&&(l=!0)}if(!s&&this.last_bucket){const s=this.last_bucket;i&&!o&&(o=!0,n()),this.greater_find_least&&r&&e[s]&&e[s].length&&(this.cf(e[s][0],t)>0?e[s]=[]:this.cf(e[s][0],t)<0&&(i=void 0)),l=!0}return o=o&&(!this.lesser_find_greatest||!this.points.length||!e[this.points[0][2]]||!e[this.points[0][2]].length||this.cf(e[this.points[0][2]][0],t)<=0),l=l&&(!this.greater_find_least||!e[this.last_bucket]||!e[this.last_bucket].length||this.cf(e[this.last_bucket][0],t)>=0),{left:o,bucket:i,right:l}}sort(t,e={}){let r;for(r=0;r<this.points.length;r++){const[n,o,s]=this.points[r];if(this.cf(t,n)<(o?1:0))return s?((!e[s]||0===r&&this.lesser_find_greatest&&e[s].length&&this.cf(e[s][0],t)<0)&&(e[s]=[]),e[s].push(t),e):e}r=this.points.length;const n=this.last_bucket;return n?((!e[n]||this.greater_find_least&&e[n].length&&this.cf(e[n][0],t)>0)&&(e[n]=[]),e[n].push(t),e):e}search_array(t){const e={};return t.forEach(t=>this.sort(t,e)),e}}e.RangeSearch=i;e.Bst=class{constructor(t){this.bst_root=void 0,this.cmp=t}gteqcmp(t,e){return this.cmp(t,e)>=0}gtcmp(t,e){return this.cmp(t,e)>0}eqcmp(t,e){return 0===this.cmp(t,e)}add(t,e=new n.MemberPtr(this,"bst_root")){e.value?this.gteqcmp(e.value.data,t)?this.add(t,new n.MemberPtr(e.value,"left")):this.add(t,new n.MemberPtr(e.value,"right")):e.value=new o(t)}create_range_search(){return new i(this.cmp)}search(t,e=new n.MemberPtr(this,"bst_root"),r={}){if(!e.value)return r;const{bucket:o,right:s}=t.getBucketInfo(e.value.data,r,!0,()=>{this.search(t,new n.MemberPtr(e.value,"left"),r)});return o&&(r[o]||(r[o]=[]),r[o].push(e.value.data)),s&&this.search(t,new n.MemberPtr(e.value,"right"),r),r}_getInorderSuccessor(t,e=new n.MemberPtr(this,"bst_root")){let r;const o=t=>{(!r||t&&this.gtcmp(r.data,t.data))&&(r=t)};return e.value&&(this.gteqcmp(e.value.data,t)&&(e.value.data!==t&&o({ptr:e,data:e.value.data}),o(this._getInorderSuccessor(t,new n.MemberPtr(e.value,"left")))),o(this._getInorderSuccessor(t,new n.MemberPtr(e.value,"right")))),r}remove(t,e=(()=>!0),r=new n.MemberPtr(this,"bst_root")){if(r.value){const o=this.cmp(r.value.data,t),s=e(r.value.data);if(o>0?this.remove(t,e,new n.MemberPtr(r.value,"left")):(o<0||this.remove(t,e,new n.MemberPtr(r.value,"left")),this.remove(t,e,new n.MemberPtr(r.value,"right"))),0===o&&s)if(r.value.left&&r.value.right){const t=this._getInorderSuccessor(r.value.data,r);this.remove(t.data,void 0,t.ptr),r.value.data=t.data}else r.value=r.value.left||r.value.right}}operateOnAllRange(t,e,r,n=this.bst_root,o=!1){n&&!o&&(this.gteqcmp(n.data,t)?this.gteqcmp(e,n.data)?(this.operateOnAllRange(t,e,r,n.left,!n.left),this.operateOnAllRange(t,e,r,n.right,!n.right),r(n)):this.operateOnAllRange(t,e,r,n.left,!n.left):this.operateOnAllRange(t,e,r,n.right,!n.right))}operateOnAllGteq(t,e,r=!0,o=new n.MemberPtr(this,"bst_root")){o.value&&(this.gteqcmp(o.value.data,t)&&(r||e(o.value),this.operateOnAllGteq(t,e,r,new n.MemberPtr(o.value,"left")),r&&e(o.value)),this.operateOnAllGteq(t,e,r,new n.MemberPtr(o.value,"right")))}operateOnAllLteq(t,e,r=!0,o=new n.MemberPtr(this,"bst_root")){o.value&&(this.gteqcmp(t,o.value.data)?(r||e(o.value),this.operateOnAllLteq(t,e,r,new n.MemberPtr(o.value,"left")),r&&e(o.value),this.operateOnAllLteq(t,e,r,new n.MemberPtr(o.value,"right"))):this.operateOnAllLteq(t,e,r,new n.MemberPtr(o.value,"left")))}operateOnAll(t,e=!0,r=new n.MemberPtr(this,"bst_root")){r.value&&(e||t(r.value),this.operateOnAll(t,e,new n.MemberPtr(r.value,"left")),e&&t(r.value),this.operateOnAll(t,e,new n.MemberPtr(r.value,"right")))}getRange(t,e){const r=[];return this.operateOnAllRange(t,e,t=>r.push(t)),r}getGteq(t){let e=[];return this.operateOnAllGteq(t,t=>{!e[0]||this.gtcmp(e[0].data,t.data)?e=[t]:this.eqcmp(e[0].data,t.data)&&e.push(t)}),e}getLteq(t){let e=[];return this.operateOnAllLteq(t,t=>{!e[0]||this.gtcmp(t.data,e[0].data)?e=[t]:this.eqcmp(e[0].data,t.data)&&e.push(t)}),e}toString(){let t="BST [\n";return this.operateOnAll(({data:e})=>{t+="  "+e.toString().split("\n").join("\n  ")+"\n"}),t+="]",t}};e.DBstNode=class{constructor(t=0){this.value=t}get absolute_value(){return this.value+(this.parent_node?this.parent_node.absolute_value:0)}addChild(t){t.value-=this.value,t.value>0||this.preferential_cmp(t)<0?this.right_node?this.right_node.addChild(t):(this.right_node=t,t.parent_node=this):this.left_node?this.left_node.addChild(t):(this.left_node=t,t.parent_node=this)}get smallest_child(){return this.left_node?this.left_node.smallest_child||this.left_node:this.right_node?this.right_node.smallest_child||this.right_node:void 0}get smallest_smaller_child(){if(this.left_node)return this.left_node.smallest_smaller_child||this.left_node}get largest_child(){return this.right_node?this.right_node.largest_child||this.right_node:this.left_node?this.left_node.largest_child||this.left_node:void 0}get largest_larger_child(){if(this.right_node)return this.right_node.largest_larger_child||this.right_node}get inorder_successor(){if(this.right_node)return this.right_node.smallest_smaller_child||this.right_node;let t=this;for(;t;){if(t.value<=0&&t.parent_node&&t.parent_node.left_node===t)return t.parent_node;t=t.parent_node}}replaceWith(t){return t&&(t.value=t.value-this.absolute_value+this.value),this.parent_node&&(this.value<=0?this.parent_node.left_node=t:this.parent_node.right_node=t,t&&(t.parent_node&&(t.parent_node.left_node===t?delete t.parent_node.left_node:t.parent_node.right_node===t&&delete t.parent_node.right_node,delete t.parent_node),t.parent_node=this.parent_node)),t&&this.left_node&&this.left_node!==t&&(t.left_node=this.left_node,t.left_node.parent_node=t,t.left_node.value+=this.value-t.value),t&&this.right_node&&this.right_node!==t&&(t.right_node=this.right_node,t.right_node.parent_node=t,t.right_node.value+=this.value-t.value),delete this.parent_node,delete this.right_node,delete this.left_node,this}removeChild(t,e=(()=>!0),r=[],n=(()=>{})){const o=()=>{this.right_node&&this.right_node.removeChild(t-this.right_node.value,e,r)};if(t<=0?(()=>{this.left_node&&this.left_node.removeChild(t-this.left_node.value,e,r)})():t>0&&o(),0===t&&e(this)){let t;if(r.push(this),this.right_node&&this.left_node){t=this.inorder_successor;const e=t.absolute_value;t.parent_node.removeChild(t.value,e=>e===t),t.value=e}else this.right_node?(t=this.right_node,t.value=t.absolute_value):this.left_node?(t=this.left_node,t.value=t.absolute_value):t=void 0;this.replaceWith(t),n(t)}return r}addSpaceBefore(t){let e=this,r=0;for(;e;)r>=0&&this.preferential_cmp(e)<=0?(r-=e.value,e.value+=t,e.left_node&&(e.left_node.value-=t)):r-=e.value,e=e.parent_node}search(t,e){e+=this.value,t.range.push_offset(-this.value);const r=()=>{this.left_node.search(t,e)},n=()=>{this.right_node.search(t,e)},o=t.range.getRangeSection(0);o<0?(t.setBucket("lesser",e,this),this.right_node&&n(),this.left_node&&0===this.left_node.value&&r()):o>0?(t.setBucket("greater",e,this),this.left_node&&r()):(t.addToBucket("range",e,this),this.left_node&&r(),this.right_node&&n()),t.range.pop_offset(-this.value)}operateOnAll(t){this.left_node&&this.left_node.operateOnAll(t),t(this),this.right_node&&this.right_node.operateOnAll(t)}};e.DBst=class{constructor(){this.bst_root=void 0}add(t){return this.bst_root?this.bst_root.addChild(t):this.bst_root=t,t}remove(t,e=(()=>!0)){const r=[];return this.bst_root&&this.bst_root.removeChild(t-this.bst_root.value,e,r,t=>{this.bst_root=t}),r}search(t){const e=new s(t);return this.bst_root&&this.bst_root.search(e,0),e}operateOnAll(t){this.bst_root&&this.bst_root.operateOnAll(t)}toString(){let t="DBST [\n";return this.operateOnAll(e=>{t+="  "+e.toString().split("\n").join("\n  ")+"\n"}),t+="]",t}}},function(t,e,r){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const n=r(4);var o;e.ListDocumentModel=n.ListDocumentModel,e.LogootInt=n.LogootInt,e.LogootPosition=n.LogootPosition,e.NodeType=n.NodeType,function(t){t[t.PENDING=0]="PENDING",t[t.SENDING=1]="SENDING",t[t.COMPLETE=2]="COMPLETE"}(o||(o={})),e.EventState=o},function(t,e,r){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const n=r(1),o=r(0),s=r(2),i=r(5);e.LogootInt=i.LogootInt,e.LogootPosition=i.LogootPosition,e.NodeType=i.NodeType;const l=r(7);class a extends Error{}const h=(t,e)=>!t.branches.filter(t=>!e.br(t)).length&&!e.branches.filter(e=>!t.br(e)).length;class c{constructor(t,e=h){this.ldoc_bst=new s.DBst,this.logoot_bst=new s.Bst((t,e)=>t.start.cmp(e.start)),this.clock=new i.LogootInt,this.branch=t,this.canJoin=e}insertLocal(t,e){const{buckets:r}=this.ldoc_bst.search(new n.NumberRange(t,t,n.RangeBounds.LOGO));let s,l,h,c;r.lesser&&r.lesser.length&&(s=r.lesser.map(([,t])=>t).sort((t,e)=>t.logoot_start.cmp(e.logoot_start))[0]),r.greater&&r.greater.length&&(l=r.greater.map(([,t])=>t).sort((t,e)=>e.logoot_start.cmp(t.logoot_start))[0]);const u=s?s.ldoc_length:0;if(s&&s.known_position+u===t){if(l&&s.last_branch===l.first_branch&&s.last_branch!==this.branch)throw new a;h=s.logoot_end,c=l?l.logoot_start:void 0}else s?(()=>{let e=t-s.known_position;if(s.branch_order.indexOf(this.branch)<0?e-=s.ldoc_length:e-=s.branchLength(s.branch_order.slice(0,s.branch_order.indexOf(this.branch))),e<0)throw new o.FatalError("Search returned out of order nodes");if(0===e){const{buckets:t}=this.ldoc_bst.search(new n.NumberRange(s.known_position,s.known_position,n.RangeBounds.LOGC));let e;return t.lesser&&t.lesser.length&&(e=t.lesser.map(([,t])=>t).sort((t,e)=>t.logoot_start.cmp(e.logoot_start))[0]),h=e.logoot_end,void(c=s.logoot_start)}for(let t=0;t<s.groups.length;t++){const{end:r}=s.groups[t];if(e-=s.groups[t].branchLength([this.branch]),e<0)return void(h=c=r.inverseOffsetLowest(-e));if(0===e)return h=r,void(c=s.groups[t+1]?s.groups[t+1].start:l?l.logoot_start:void 0)}throw new a})():l&&(c=l.logoot_start);return{start:new i.LogootPosition(e,h,c),length:e,br:this.branch,rclk:this.clock}}removeLocal(t,e){const{buckets:r}=this.ldoc_bst.search(new n.NumberRange(t,t+e,n.RangeBounds.LOGC)),s=r.range.map(([,t])=>t);if(r.lesser&&r.lesser.length){const e=r.lesser.map(([,t])=>t).sort((t,e)=>t.logoot_start.cmp(e.logoot_start))[0];e.ldoc_end>t&&s.unshift(e)}const l={};let a=t+e-s[0].known_position;o.catchBreak(()=>s.forEach(t=>{t.branch_order.forEach(r=>{t.groups.forEach(t=>{if(!t.br(r))return;let{start:n,length:s}=t;const{type:h,rclk:c}=t.br(r);if(h===i.NodeType.DATA&&(a>e&&(n=n.offsetLowest(a-e),s-=a-e),function(t,e,r,n){if(r<=0)return;l[t]||(l[t]={});const o=l[t];o[e.levels]||(o[e.levels]=[]);const s=o[e.levels],i=s[s.length-1];i&&i.branch===t&&0===i.start.offsetLowest(i.length).cmp(e)&&0===i.rclk.cmp(n)?i.length+=r:s.push({branch:t,start:e,length:r,rclk:n})}(r,n,Math.min(s,a),c),a-=t.length),a<=0)throw o.BreakException})})}));const h=[];return o.allValues(l).forEach(t=>{Object.entries(t).forEach(([,t])=>{t.forEach(t=>h.push(t))})}),{removals:h}}_mergeNode(t,e,r,s,a,h){this.debug_logger&&this.debug_logger.log({br:t,start:e,length:r,rclk:s,type:a}),l.debug.info(`Merging ${a} ${String(t)} ${e} + ${r} @ ${s}`);const c=e.levels,u=e.offsetLowest(r);this.clock.cmp(s)<0&&this.clock.assign(s);const d=this.logoot_bst.create_range_search();d.lesser_find_greatest=!0,d.greater_find_least=!0,d.push_point({start:e},"_lesser",!1),d.push_point({start:u},"_skip_ranges",!1),d.all_greater("_greater");const{_lesser:g,_skip_ranges:p,_greater:f}=this.logoot_bst.search(d);let _,b;if(g&&g.length>1)throw new o.FatalError("Corrupt BST. There are multiple nodes at a position.");if(g&&g.length&&(_=g[0]),f&&f.length>1)throw new o.FatalError("Corrupt BST. There are multiple nodes at a position.");f&&f.length&&(b=f[0]);let m=p?p.sort((t,e)=>t.start.cmp(e.start)):[];if(_&&m.includes(_)&&m.splice(m.indexOf(_),1),b&&m.includes(b)&&m.splice(m.indexOf(b),1),_&&m.unshift(_),_&&_.start.levels<c&&_.start.cmp(e)<0&&_.end.cmp(u)>0){const t=e.copy().level(_.start.levels).sub(_.start.level(_.start.levels)).js_int;if(t>0&&t<_.length){const e=_.splitAround(t);m.push(e),this.logoot_bst.add(e)}}b&&!m.includes(b)&&m.push(b);let v=[];if(m.length){const t=m[m.length-1].group.ldoc_end;v=this.ldoc_bst.search(new n.NumberRange(m[0].group.known_position,t)).buckets.range.sort((t,e)=>t[0]-e[0]).map(([,t])=>t)}if(m=m.filter(({start:t})=>t.levels>=c||t.cmp(u)>=0),!m.length||m[m.length-1].start.cmp(u)<0){const t=new i.LogootNodeGroup;t.start=u,m.push(t)}const w=[],y=(t,e,r,n)=>{if(0===n)return;w.push({type:"i",start:e,offset:r,length:n});const o=t.inorder_successor;o&&o.addSpaceBefore(n)},O=(t,e,r)=>{0!==e&&t!==r&&w.push({type:"t",source:t,length:e,dest:r})},L=(t,e)=>{if(!t.groups.includes(e))throw new o.FatalError("Node group not in conflict group.");if(!v.includes(t))throw new o.FatalError("Conflict group not in conflict_order");const r=new i.ConflictGroup(t.ldoc_end);let n=t.known_position;const s=r.known_position;return t.branch_order.forEach(i=>{const l=(()=>{let r=0;for(let n=0;n<t.groups.length;n++)if(r+=t.groups[n].branchLength([i]),t.groups[n]===e)return r;throw new o.FatalError})();r.branch_order.push(i);const a=t.branchLength([i])-l;r.value-=a,n+=l,O(n,a,s-a)}),r.groups=t.groups.splice(t.groups.indexOf(e)+1,t.groups.length),r.groups.forEach(t=>t.group=r),this.ldoc_bst.add(r),v.splice(v.indexOf(t)+1,0,r),r},k=(t,e)=>{e.branch_order.forEach(e=>{t.branch_order.includes(e)||t.branch_order.push(e)}),e.groups.forEach(e=>e.group=t),t.groups.splice(t.groups.length,0,...e.groups);let r=e.known_position,n=t.known_position;e.branch_order.forEach(o=>{n+=t.branchLength([o]);const s=e.branchLength([o]);O(r,s,n-s),r+=s}),e.branch_order.length=0,e.groups=[],this.ldoc_bst.remove(e.known_position,t=>t===e),v.splice(v.indexOf(e),1)};let A=e.level(c),N=_;return m.forEach((n,o)=>{let d=m[o+1];const g=n.start.clamp(e,u,c).l(c),p=n.end.clamp(e,u,c).l(c),f=g.copy().sub(A).js_int,_=A.copy().sub(e.l(c)).js_int;if(f>0||n.start.levels<c&&r-_>0&&n.start.cmp(e)>0&&A.cmp(e.l(c))<0){const o=new i.LogootNodeGroup;o.start=e.copy(),o.start.l(c).assign(A),o.length=f||r-_,o.br(t,{type:a,rclk:s}),l.debug.info(`Creating new group at ${o.start.toString()}`);const u=N&&h(N,o),d=n&&h(o,n),g=N&&n&&N.group===n.group;if(!g&&u&&d?k(N.group,n.group):!g||u&&d||L(N.group,N),u||d?o.group=u?N.group:n.group:(o.group=new i.ConflictGroup(N?N.group.ldoc_end:0),o.group.branch_order.push(t),v.splice(N?v.indexOf(N.group)+1:0,0,o.group)),a===i.NodeType.DATA){const t=o.group.insertSingleBranchGroup(o);u||d||this.ldoc_bst.add(o.group),y(o.group,t,_,o.length)}else o.group.insertSingleBranchGroup(o),u||d||this.ldoc_bst.add(o.group);N=o,this.logoot_bst.add(o)}const b=p.copy().sub(g).js_int,O=g.copy().sub(e.l(c)).js_int;if(n.start.levels===c&&b>0&&(!n.br(t)||s.cmp(n.br(t).rclk)>(a===i.NodeType.DATA?0:-1))){if(n.start.cmp(e)<0&&(N=n,n=n.splitAround(e.l(c).sub(n.start.l(c)).js_int),this.logoot_bst.add(n)),n.end.cmp(u)>0){const t=n.splitAround(n.length-n.end.l(c).sub(u.l(c)).js_int);this.logoot_bst.add(t),d=t}l.debug.info(`Adding to existing group at ${n.start.toString()}`),n.group.branch_order.includes(t)||n.group.branch_order.push(t);const r=n.group.insertPos(t,n);n.br(t)&&n.br(t).type===i.NodeType.DATA&&((t,e,r)=>{if(0===r)return;w.push({type:"r",start:e,length:r});const n=t.inorder_successor;n&&n.addSpaceBefore(-r)})(n.group,r,n.length),n.br(t,{type:a,rclk:s}),a===i.NodeType.DATA&&y(n.group,r,O,n.length);const o=(t,e)=>{if(!t||!e)return;const r=t.group===e.group,n=h(t,e);!r&&n?k(t.group,e.group):r&&!n&&L(t.group,t)};o(N,n),o(n,d)}A=n.end.clamp(e,u,c).level(c),N=n}),v.forEach(({known_position:t,ldoc_length:e,conflicted:r})=>{((t,e,r)=>{0!==e&&w.push({type:"m",start:t,length:e,conflicting:r})})(t,e,r)}),w}insertLogoot(t,e,r,n){return this._mergeNode(t,e,r,n,i.NodeType.DATA,this.canJoin)}removeLogoot(t,e,r,n){return this._mergeNode(t,e,r,n,i.NodeType.REMOVAL,this.canJoin)}selfTest(){let t,e=0;this.ldoc_bst.operateOnAll(r=>{if(!r.groups.length)throw new o.FatalError("Node with no groups detected.");if(r.known_position!==e)throw new Error(`Ldoc is out of order. Found known position ${r.known_position} after ${e}`);e=r.ldoc_end,r.groups.forEach(({start:e})=>{if(t&&t.cmp(e)>=0)throw new o.FatalError(`Ldoc is out of order. Found ${e.toString()} after ${t.toString()}.`);t=e})})}}e.ListDocumentModel=c,function(t){t.JsonableLogger=class{constructor(){this.ops=[]}log(t){this.ops.push(t)}replayAll(t,e=(()=>{})){let r,n=[];return this.ops.forEach(o=>{r=t._mergeNode(o.br,o.start,o.length,o.rclk,o.type,t.canJoin),n=n.concat(r),e(t,o,r)}),n}restoreFromJSON(t){return this.ops=t.map(t=>({br:`BR[${t.b.toString(16)}]`,start:i.LogootPosition.fromJSON(t.s),length:t.l,rclk:i.LogootInt.fromJSON(t.r),type:"D"===t.t?i.NodeType.DATA:"R"===t.t?i.NodeType.REMOVAL:(()=>{throw new TypeError("Node type was not one of DATA or REMOVAL")})()})),this}toJSON(){const t={};let e=0;return this.ops.map(r=>{return{b:(n=r.br,void 0===t[n]&&(t[n]=e++),t[n]),s:r.start.toJSON(),l:r.length,r:r.rclk.toJSON(),t:r.type===i.NodeType.DATA?"D":i.NodeType.REMOVAL?"R":(()=>{throw new TypeError("Node type was not one of DATA or REMOVAL")})()};var n})}}}(c||(c={})),e.ListDocumentModel=c},function(t,e,r){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const n=r(2),o=r(6),s=r(0);var i,l=o.Int32;e.LogootInt=l;class a{constructor(t=0,e,r){if(this.start=e,this.end=r,this.array=[new l(0)],!e&&r)this.array=r.inverseOffsetLowest(t).array;else if(!r&&e)this.array=e.copy().array;else if(e&&r){let n=!1;const o=e.array.values(),s=r.array.values();let i,a;for(this.array.length=0;!n;)i&&i.done||(i=o.next()),a&&a.done||(a=s.next()),i.done||a.done?i.done?a.done?(this.array.push(new l),n=!0):(this.array.push(new l(a.value).sub(t)),n=!0):(this.array.push(new l(i.value)),n=!0):(a.value.gteq(new l(i.value).add(t))&&(n=!0),this.array.push(new l(i.value)))}}static fromJSON(t){const e=new a;return e.array.length=0,t.forEach(t=>{e.array.push(l.fromJSON(t))}),e}static fromInts(...t){const e=new a;return e.array.length=0,t.forEach(t=>{e.array.push(new l(t))}),e}toJSON(){return this.array.map(t=>t.toJSON())}get length(){return this.array.length}get levels(){return this.length-1}level(t){return this.array[t]}l(t){return this.level(t)}offsetLowest(t){return Object.assign(new a,{array:this.array.map((e,r,n)=>r<n.length-1?e:new l(e).add(t))})}inverseOffsetLowest(t){return Object.assign(new a,{array:this.array.map((e,r,n)=>r<n.length-1?e:new l(e).sub(t))})}copy(){return Object.assign(new a,{array:this.array.map(t=>new l(t))})}equivalentPositionAtLevel(t){return Object.assign(new a,{array:new Array(t+1).fill(0,0,t+1).map((t,e)=>new l(this.array[e]))})}cmp(t,e=0){if(e>=this.length)return this.length===t.length?0:1;if(e>=t.length)return-1;switch(this.level(e).cmp(t.level(e))){case 1:return 1;case-1:return-1;case 0:return this.cmp(t,e+1);default:return 0}}clamp(t,e,r){const n=this.cmp(t)<0?t:this.cmp(e)>0?e:this;return void 0!==r?n.equivalentPositionAtLevel(r):n.copy()}toString(){let t="[";return this.array.forEach((e,r,n)=>{t+=e.toString()+(r>=n.length-1?"":",")}),t+="]",t}}e.LogootPosition=a,function(t){let e;!function(t){t.Schema={type:"array",items:l.JSON.Schema}}(e=t.JSON||(t.JSON={}))}(a||(a={})),e.LogootPosition=a,function(t){t[t.DATA=0]="DATA",t[t.REMOVAL=1]="REMOVAL"}(i||(i={})),e.NodeType=i;const h={[i.DATA]:"DATA",[i.REMOVAL]:"REMOVAL"};class c extends n.DBstNode{constructor(t){super(t),this.branch_order=[],this.groups=[]}get known_position(){return this.absolute_value}get ldoc_length(){return this.groups.reduce((t,e)=>t+e.ldoc_length,0)}get ldoc_end(){return this.known_position+this.ldoc_length}get logoot_start(){return this.groups[0]?this.groups[0].start:void 0}get logoot_end(){return this.groups.length?this.groups[this.groups.length-1].end:void 0}preferential_cmp(t){return t.logoot_start?this.logoot_start.cmp(t.logoot_start):0}get first_branch(){return this.branch_order[0]}get last_branch(){return this.branch_order.length?this.branch_order[this.branch_order.length-1]:void 0}get conflicted(){return this.groups.some(t=>t.conflicted)}branchLength(t){return this.groups.reduce((e,r)=>e+r.branchLength(t),0)}insertPos(t,e){let r=this.known_position+this.branchLength(this.branch_order.slice(0,this.branch_order.indexOf(t)+(e?0:1)));if(!e)return r;for(let n=0;n<this.groups.length;n++){if(this.groups[n]===e)return r;r+=this.groups[n].branchLength([t])}throw new s.FatalError("Tried to insert after a LogootNodeGroup that is not in this conflict group")}getNeighbors({start:t}){let e;for(let r=0;r<this.groups.length;r++)if(this.groups[r].start.cmp(t)<=0&&(e=this.groups[r]),this.groups[r].start.cmp(t)>0)return{left:e,right:this.groups[r],pos:r};return{left:e,right:void 0,pos:this.groups.length}}insertSingleBranchGroup(t){if(1!==t.n_branches)throw new TypeError("Passed group with no or more than one branch");if(t.group!==this)throw new TypeError("Conflict group not assigned to node group");const e=t.branches[0];this.branch_order.includes(e)||this.branch_order.push(e);const{right:r,pos:n}=this.getNeighbors(t),o=this.insertPos(e,r);return this.groups.splice(n,0,t),o}toString(){let t=`Conflict @ ${this.known_position} (`;return t+=this.branch_order.map(t=>t.toString()).join(" "),t+=") {",t+=this.groups.map(t=>"\n  "+t.toString().split("\n").join("\n  ")),t+="\n}",t}}e.ConflictGroup=c;class u{constructor(t){this.length=0,this.start=new a,this.nodes={},t&&(Object.assign(this,{length:t.length,start:t.start.copy(),group:t.group}),t.eachNode(({type:t,rclk:e},r)=>{this.br(r,{type:t,rclk:new l(e)})}))}get ldoc_length(){return this.branches.reduce((t,e)=>this.br(e).type===i.DATA?t+this.length:t,0)}branchLength(t){return this.branches.filter(e=>t.includes(e)).reduce((t,e)=>this.br(e).type===i.DATA?t+this.length:t,0)}get end(){return this.start.offsetLowest(this.length)}get branches(){return s.allKeys(this.nodes)}get n_branches(){return this.branches.length}get conflicted(){return this.n_branches>1}eachNode(t){this.branches.forEach(e=>{t(this.br(e),e)})}mapNodes(t){const e={};return this.branches.forEach(r=>{e[r]=t(this.br(r),r)}),e}br(t,e){return e&&(this.nodes[t]=e),this.nodes[t]}delBr(t){delete this.nodes[t]}splitAround(t){const e=new u(this);e.start=this.start.offsetLowest(t),e.length=this.length-t;const r=e.group.groups;return r.splice(r.indexOf(this)+1,0,e),this.length=t,e}toString(){let t=`Group ${this.start.toString()} + ${this.length} {`;return t+=this.branches.map(t=>{const e=this.br(t);return`\n  ${String(t)}: ${h[e.type]} @ ${e.rclk.toString()}`}),t+="\n}",t}}e.LogootNodeGroup=u},function(t,e,r){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const n=r(0);class o extends n.Comparable{}e.IntType=o;class s extends o{constructor(t=0){super(),this.int32=new Int32Array([0]),this.int32[0]=t instanceof s?t.int32[0]:t}static fromJSON(t){return new s(t)}toJSON(){return this.int32[0]}add(t){return this.int32[0]+=t instanceof s?t.int32[0]:t,this}sub(t){return this.int32[0]-=t instanceof s?t.int32[0]:t,this}assign(t){return this.int32[0]=t instanceof s?t.int32[0]:t,this}cmp(t){return t instanceof s?(this.int32[0]>=t.int32[0]?1:0)+(this.int32[0]<=t.int32[0]?-1:0):(this.int32[0]>=t?1:0)+(this.int32[0]<=t?-1:0)}copy(){return new s(this)}get js_int(){return this.int32[0]}toString(){return this.int32[0].toString()}}e.Int32=s,function(t){let e;!function(t){t.Schema={type:"number"}}(e=t.JSON||(t.JSON={}))}(s||(s={})),e.Int32=s},function(t,e,r){"use strict";var n=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(e,"__esModule",{value:!0});const o=n(r(8)).default.getLogger("logootish-js");e.debug=o},function(t,e,r){var n,o;!function(s,i){"use strict";void 0===(o="function"==typeof(n=function(){var t=function(){},e="undefined"!=typeof window&&void 0!==window.navigator&&/Trident\/|MSIE /.test(window.navigator.userAgent),r=["trace","debug","info","warn","error"];function n(t,e){var r=t[e];if("function"==typeof r.bind)return r.bind(t);try{return Function.prototype.bind.call(r,t)}catch(e){return function(){return Function.prototype.apply.apply(r,[t,arguments])}}}function o(){console.log&&(console.log.apply?console.log.apply(console,arguments):Function.prototype.apply.apply(console.log,[console,arguments])),console.trace&&console.trace()}function s(r){return"debug"===r&&(r="log"),"undefined"!=typeof console&&("trace"===r&&e?o:void 0!==console[r]?n(console,r):void 0!==console.log?n(console,"log"):t)}function i(e,n){for(var o=0;o<r.length;o++){var s=r[o];this[s]=o<e?t:this.methodFactory(s,e,n)}this.log=this.debug}function l(t,e,r){return function(){"undefined"!=typeof console&&(i.call(this,e,r),this[t].apply(this,arguments))}}function a(t,e,r){return s(t)||l.apply(this,arguments)}function h(t,e,n){var o,s=this,l="loglevel";function h(){var t;if("undefined"!=typeof window){try{t=window.localStorage[l]}catch(t){}if(void 0===t)try{var e=window.document.cookie,r=e.indexOf(encodeURIComponent(l)+"=");-1!==r&&(t=/^([^;]+)/.exec(e.slice(r))[1])}catch(t){}return void 0===s.levels[t]&&(t=void 0),t}}t&&(l+=":"+t),s.name=t,s.levels={TRACE:0,DEBUG:1,INFO:2,WARN:3,ERROR:4,SILENT:5},s.methodFactory=n||a,s.getLevel=function(){return o},s.setLevel=function(e,n){if("string"==typeof e&&void 0!==s.levels[e.toUpperCase()]&&(e=s.levels[e.toUpperCase()]),!("number"==typeof e&&e>=0&&e<=s.levels.SILENT))throw"log.setLevel() called with invalid level: "+e;if(o=e,!1!==n&&function(t){var e=(r[t]||"silent").toUpperCase();if("undefined"!=typeof window){try{return void(window.localStorage[l]=e)}catch(t){}try{window.document.cookie=encodeURIComponent(l)+"="+e+";"}catch(t){}}}(e),i.call(s,e,t),"undefined"==typeof console&&e<s.levels.SILENT)return"No console available for logging"},s.setDefaultLevel=function(t){h()||s.setLevel(t,!1)},s.enableAll=function(t){s.setLevel(s.levels.TRACE,t)},s.disableAll=function(t){s.setLevel(s.levels.SILENT,t)};var c=h();null==c&&(c=null==e?"WARN":e),s.setLevel(c,!1)}var c=new h,u={};c.getLogger=function(t){if("string"!=typeof t||""===t)throw new TypeError("You must supply a name when creating a logger.");var e=u[t];return e||(e=u[t]=new h(t,c.getLevel(),c.methodFactory)),e};var d="undefined"!=typeof window?window.log:void 0;return c.noConflict=function(){return"undefined"!=typeof window&&window.log===c&&(window.log=d),c},c.getLoggers=function(){return u},c})?n.call(e,r,e,t):n)||(t.exports=o)}()}])}));
//# sourceMappingURL=logootish-js.min.js.map