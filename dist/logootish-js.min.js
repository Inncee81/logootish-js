!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define("logootish-js",[],e):"object"==typeof exports?exports["logootish-js"]=e():t["logootish-js"]=e()}("undefined"!=typeof self?self:this,(function(){return function(t){var e={};function r(s){if(e[s])return e[s].exports;var n=e[s]={i:s,l:!1,exports:{}};return t[s].call(n.exports,n,n.exports,r),n.l=!0,n.exports}return r.m=t,r.c=e,r.d=function(t,e,s){r.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:s})},r.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},r.t=function(t,e){if(1&e&&(t=r(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var s=Object.create(null);if(r.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var n in t)r.d(s,n,function(e){return t[e]}.bind(null,n));return s},r.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return r.d(e,"a",e),e},r.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},r.p="",r(r.s=1)}([function(t,e,r){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.arraymap=function(t,e){for(let r=0;r<t.length;){const s=e(t[r]);t.splice(r,1,...s),r+=s.length?s.length:1}return t};class s extends Error{constructor(){super(...arguments),this.fatal=!0}}e.FatalError=s;e.Comparable=class{gt(t){return 1===this.cmp(t)}gteq(t){return this.cmp(t)>=0}eq(t){return 0===this.cmp(t)}lteq(t){return this.cmp(t)<=0}lt(t){return-1===this.cmp(t)}};function n(t){return Object.keys(t).concat(Object.getOwnPropertySymbols(t))}e.MemberPtr=class{constructor(t,e){this.obj=t,this.key=e}get value(){return this.obj[this.key]}set value(t){this.obj[this.key]=t}},e.allKeys=n,e.allValues=function(t){return n(t).map(e=>t[e])};const o={};e.BreakException=o,e.catchBreak=function(t){try{t()}catch(t){if(t!==o)throw t}}},function(t,e,r){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const s=r(2);var n;e.ListDocumentModel=s.ListDocumentModel,e.LogootInt=s.LogootInt,e.LogootPosition=s.LogootPosition,e.NodeType=s.NodeType,function(t){t[t.PENDING=0]="PENDING",t[t.SENDING=1]="SENDING",t[t.COMPLETE=2]="COMPLETE"}(n||(n={})),e.EventState=n},function(t,e,r){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const s=r(0),n=r(3),o=r(4);e.LogootInt=o.LogootInt,e.LogootPosition=o.LogootPosition,e.NodeType=o.NodeType;class i extends Error{}const a=(t,e)=>!t.branches.filter(t=>!e.br(t)).length&&!e.branches.filter(e=>!t.br(e)).length;e.ListDocumentModel=class{constructor(t,e=a){this.ldoc_bst=new n.Bst((t,e)=>t.known_position-e.known_position),this.logoot_bst=new n.Bst((t,e)=>t.start.cmp(e.start)),this.clock=new o.LogootInt,this.branch=t,this.canJoin=e}insertLocal(t,e){const r=this.ldoc_bst.create_range_search();r.lesser_find_greatest=!0,r.greater_find_least=!0,r.push_point({known_position:t},"_lesser",!1),r.all_greater("_greater");const{_lesser:n,_greater:a}=this.ldoc_bst.search(r);let h,l,c,u;n&&n.length&&(h=n.sort((t,e)=>t.logoot_start.cmp(e.logoot_start))[0]),a&&a.length&&(l=a.sort((t,e)=>e.logoot_start.cmp(t.logoot_start))[0]);const p=h?h.ldoc_length:0;if(h&&h.known_position+p===t){if(l&&h.last_branch===l.first_branch&&h.last_branch!==this.branch)throw new i;c=h.logoot_end,u=l?l.logoot_start:void 0}else h?(()=>{let e=t-h.known_position;if(h.branch_order.indexOf(this.branch)<0?e-=h.ldoc_length:e-=h.branchLength(h.branch_order.slice(0,h.branch_order.indexOf(this.branch))),e<0)throw new s.FatalError("Search returned out of order nodes");if(0===e){const t=this.ldoc_bst.create_range_search();t.lesser_find_greatest=!0,t.push_point({known_position:h.known_position},"_lesser",!1);const{_lesser:e}=this.ldoc_bst.search(t);let r;return e&&e.length&&(r=e.sort((t,e)=>t.logoot_start.cmp(e.logoot_start))[0]),c=r.logoot_end,void(u=h.logoot_start)}for(let t=0;t<h.groups.length;t++){const{end:r}=h.groups[t];if(e-=h.groups[t].branchLength([this.branch]),e<0)return void(c=u=r.inverseOffsetLowest(-e));if(0===e)return c=r,void(u=h.groups[t+1]?h.groups[t+1].start:l?l.logoot_start:void 0)}throw new i})():l&&(u=l.logoot_start);return{start:new o.LogootPosition(e,c,u),length:e,br:this.branch,rclk:this.clock}}removeLocal(t,e){const r=this.ldoc_bst.create_range_search();r.lesser_find_greatest=!0,r.greater_find_least=!0,r.push_point({known_position:t},"_lesser",!1),r.push_point({known_position:t+e},"_range",!1),r.all_greater(void 0);const{_lesser:n,_range:i}=this.ldoc_bst.search(r),a=i||[];if(n&&n.length){const e=n.sort((t,e)=>t.logoot_start.cmp(e.logoot_start))[0];e.ldoc_end>t&&a.unshift(e)}const h={};let l=t+e-a[0].known_position;s.catchBreak(()=>a.forEach(t=>{t.branch_order.forEach(r=>{t.groups.forEach(t=>{if(!t.br(r))return;let{start:n,length:i}=t;const{type:a,rclk:c}=t.br(r);if(a===o.NodeType.DATA&&(l>e&&(n=n.offsetLowest(l-e),i-=l-e),function(t,e,r,s){if(r<=0)return;h[t]||(h[t]={});const n=h[t];n[e.levels]||(n[e.levels]=[]);const o=n[e.levels],i=o[o.length-1];i&&i.branch===t&&0===i.start.offsetLowest(i.length).cmp(e)&&0===i.rclk.cmp(s)?i.length+=r:o.push({branch:t,start:e,length:r,rclk:s})}(r,n,Math.min(i,l),c),l-=t.length),l<=0)throw s.BreakException})})}));const c=[];return s.allValues(h).forEach(t=>{Object.entries(t).forEach(([,t])=>{t.forEach(t=>c.push(t))})}),{removals:c}}_mergeNode(t,e,r,n,i,a){const h=e.levels,l=e.offsetLowest(r);this.clock.cmp(n)<0&&this.clock.assign(n);const c=this.logoot_bst.create_range_search();c.lesser_find_greatest=!0,c.greater_find_least=!0,c.push_point({start:e},"_lesser",!1),c.push_point({start:l},"_skip_ranges",!1),c.all_greater("_greater");const{_lesser:u,_skip_ranges:p,_greater:g}=this.logoot_bst.search(c);let d,f;if(u&&u.length>1)throw new s.FatalError("Corrupt BST. There are multiple nodes at a position.");if(u&&u.length&&(d=u[0]),g&&g.length>1)throw new s.FatalError("Corrupt BST. There are multiple nodes at a position.");g&&g.length&&(f=g[0]);const _=p?p.sort((t,e)=>t.start.cmp(e.start)):[];if(d&&_.includes(d)&&_.splice(_.indexOf(d),1),f&&_.includes(f)&&_.splice(_.indexOf(f),1),d&&_.unshift(d),d&&d.start.levels<h&&d.start.cmp(e)<0&&d.end.cmp(l)>0){const t=d.splitAround(e.copy().level(d.start.levels).sub(d.start.level(d.start.levels)).js_int);_.push(t)}else f&&_.push(f);if(!_.length||_[_.length-1].end.cmp(l)<0){const t=new o.LogootNodeGroup;t.start=l,_.push(t)}let b=[];_.forEach(({group:t})=>{t&&!b.includes(t)&&t.branch_order.length&&b.push(t)}),b=b.sort((t,e)=>t.known_position-e.known_position);const m=b.length?b[b.length-1].ldoc_end:0,w=[];let v=0;const y=(t,e,r,s)=>{v+=r;const n=t.logoot_start;for(let o=b.length-1;o>0;o--){const i=b[o];if(s){if(i.known_position<e||i.logoot_start.cmp(n)<0)return}else if(i.known_position<=e||i.logoot_start.cmp(n)<=0)return;i!==t&&(b[o].known_position+=r)}},O=(t,e,r,s)=>{0!==s&&(w.push({type:"i",start:e,offset:r,length:s}),y(t,e,s,!0))},k=(t,e,r)=>{0!==e&&t!==r&&w.push({type:"t",source:t,length:e,dest:r})},L=(t,e)=>{if(!t.groups.includes(e))throw new s.FatalError("Node group not in conflict group.");if(!b.includes(t))throw new s.FatalError("Conflict group not in conflict_order");const r=new o.ConflictGroup(t.ldoc_end);let n=t.known_position;const i=r.known_position;return t.branch_order.forEach(o=>{const a=(()=>{let r=0;for(let s=0;s<t.groups.length;s++)if(r+=t.groups[s].branchLength([o]),t.groups[s]===e)return r;throw new s.FatalError})();r.branch_order.push(o);const h=t.branchLength([o])-a;r.known_position-=h,n+=a,k(n,h,i-h)}),r.groups=t.groups.splice(t.groups.indexOf(e)+1,t.groups.length),r.groups.forEach(t=>t.group=r),this.ldoc_bst.add(r),b.splice(b.indexOf(t)+1,0,r),r},A=(t,e)=>{e.branch_order.forEach(e=>{t.branch_order.includes(e)||t.branch_order.push(e)}),e.groups.forEach(e=>e.group=t),t.groups.splice(t.groups.length,0,...e.groups);let r=e.known_position,s=t.known_position;e.branch_order.forEach(n=>{s+=t.branchLength([n]);const o=e.branchLength([n]);k(r,o,s-o),r+=o}),e.branch_order.length=0,e.groups=[],this.ldoc_bst.remove(e,t=>t===e),b.splice(b.indexOf(e),1)};let P=e.level(h),E=d;return _.forEach((s,c)=>{let u=_[c+1];const p=s.start.clamp(e,l,h).l(h),g=s.end.clamp(e,l,h).l(h),d=p.copy().sub(P).js_int,f=P.copy().sub(e.l(h)).js_int;if(d>0||s.start.levels<h&&r-f>0){const l=new o.LogootNodeGroup;l.start=e.copy(),l.start.l(h).assign(P),l.length=d||r-f,l.br(t,{type:i,rclk:n});const c=E&&a(E,l),u=s&&a(l,s),p=E&&s&&E.group===s.group;!p&&c&&u?A(E.group,s.group):!p||c&&u||L(E.group,E),c||u?l.group=c?E.group:s.group:(l.group=new o.ConflictGroup(E?E.group.ldoc_end:0),l.group.branch_order.push(t),this.ldoc_bst.add(l.group),b.splice(E?b.indexOf(E.group)+1:0,0,l.group)),i===o.NodeType.DATA?O(l.group,l.group.insertSingleBranchGroup(l),f,l.length):l.group.insertSingleBranchGroup(l),E=l,this.logoot_bst.add(l)}const m=g.copy().sub(p).js_int,v=p.copy().sub(e.l(h)).js_int;if(s.start.levels===h&&m>0&&(!s.br(t)||n.cmp(s.br(t).rclk)>(i===o.NodeType.DATA?0:-1))){if(s.start.cmp(e)<0&&(E=s,s=s.splitAround(e.l(h).sub(s.start.l(h)).js_int),this.logoot_bst.add(s)),s.end.cmp(l)>0){const t=s.splitAround(s.end.l(h).sub(l.l(h)).js_int);this.logoot_bst.add(t),u=t}s.group.branch_order.includes(t)||s.group.branch_order.push(t);const r=s.group.insertPos(t,s);s.br(t)&&s.br(t).type===o.NodeType.DATA&&((t,e,r)=>{0!==r&&(w.push({type:"r",start:e,length:r}),y(t,e,-r,!0))})(s.group,r,s.length),s.br(t,{type:i,rclk:n}),i===o.NodeType.DATA&&O(s.group,r,v,s.length);const c=(t,e)=>{if(!t||!e)return;const r=t.group===e.group,s=a(t,e);!r&&s?A(t.group,e.group):r&&!s&&L(t.group,t)};c(E,s),c(s,u)}P=s.end.clamp(e,l,h).level(h),E=s}),b.forEach(({known_position:t,ldoc_length:e,conflicted:r})=>{((t,e,r)=>{0!==e&&w.push({type:"m",start:t,length:e,conflicting:r})})(t,e,r)}),this.ldoc_bst.operateOnAllGteq({known_position:m},({data:t})=>{if(!t.groups.length)throw new s.FatalError("An empty conflict group was found in the BST");t.logoot_start.cmp(l)<0||b.includes(t)||(t.known_position+=v)}),w}insertLogoot(t,e,r,s){return this._mergeNode(t,e,r,s,o.NodeType.DATA,this.canJoin)}removeLogoot(t,e,r,s){return this._mergeNode(t,e,r,s,o.NodeType.REMOVAL,this.canJoin)}}},function(t,e,r){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const s=r(0);class n{constructor(t){this.data=t}}e.BstNode=n;class o{constructor(t){this.lesser_find_greatest=!1,this.greater_find_least=!1,this.points=[],this.cf=t}static lteq(t,e,r){const s=new o(t);return s.points.push([e,!0,r]),s.last_bucket=void 0,s}static lt(t,e,r){const s=new o(t);return s.points.push([e,!1,r]),s.last_bucket=void 0,s}static gteq(t,e,r){const s=new o(t);return s.points.push([e,!1,void 0]),s.last_bucket=r,s}static gt(t,e,r){const s=new o(t);return s.points.push([e,!0,void 0]),s.last_bucket=r,s}push_point(t,e,r=!1){const s=[t,r,e];for(let e=0;e<this.points.length;e++)if(this.cf(t,this.points[e][0])<0)return void this.points.splice(e,0,s);this.points.push(s)}all_greater(t){this.last_bucket=t}getBucketInfo(t,e,r=!1,s){let n=!1,o=!1,i=this.last_bucket,a=Boolean(this.last_bucket);!this.points.length&&this.last_bucket&&(!n&&s&&s(),n=!0);for(let h=0;h<this.points.length;h++){const[l,c,u]=this.points[h];u&&!o&&(!n&&s&&s(),n=!0),this.cf(t,l)<(c?1:0)&&(o||(o=!0,i=u),0==h&&this.lesser_find_greatest&&r&&e[u]&&e[u].length&&(this.cf(e[u][0],t)<0?e[u]=[]:this.cf(e[u][0],t)>0&&(i=void 0))),u&&o&&0!==this.cf(l,t)&&(a=!0)}if(!o&&this.last_bucket){const o=this.last_bucket;i&&!n&&(n=!0,s()),this.greater_find_least&&r&&e[o]&&e[o].length&&(this.cf(e[o][0],t)>0?e[o]=[]:this.cf(e[o][0],t)<0&&(i=void 0)),a=!0}return n=n&&(!this.lesser_find_greatest||!this.points.length||!e[this.points[0][2]]||!e[this.points[0][2]].length||this.cf(e[this.points[0][2]][0],t)<=0),a=a&&(!this.greater_find_least||!e[this.last_bucket]||!e[this.last_bucket].length||this.cf(e[this.last_bucket][0],t)>=0),{left:n,bucket:i,right:a}}sort(t,e={}){let r;for(r=0;r<this.points.length;r++){const[s,n,o]=this.points[r];if(this.cf(t,s)<(n?1:0))return o?((!e[o]||0===r&&this.lesser_find_greatest&&e[o].length&&this.cf(e[o][0],t)<0)&&(e[o]=[]),e[o].push(t),e):e}r=this.points.length;const s=this.last_bucket;return s?((!e[s]||this.greater_find_least&&e[s].length&&this.cf(e[s][0],t)>0)&&(e[s]=[]),e[s].push(t),e):e}search_array(t){const e={};return t.forEach(t=>this.sort(t,e)),e}}e.RangeSearch=o;e.Bst=class{constructor(t){this.bst_root=void 0,this.cmp=t}gteqcmp(t,e){return this.cmp(t,e)>=0}gtcmp(t,e){return this.cmp(t,e)>0}eqcmp(t,e){return 0===this.cmp(t,e)}add(t,e=new s.MemberPtr(this,"bst_root")){e.value?this.gteqcmp(e.value.data,t)?this.add(t,new s.MemberPtr(e.value,"left")):this.add(t,new s.MemberPtr(e.value,"right")):e.value=new n(t)}create_range_search(){return new o(this.cmp)}search(t,e=new s.MemberPtr(this,"bst_root"),r={}){if(!e.value)return r;const{bucket:n,right:o}=t.getBucketInfo(e.value.data,r,!0,()=>{this.search(t,new s.MemberPtr(e.value,"left"),r)});return n&&(r[n]||(r[n]=[]),r[n].push(e.value.data)),o&&this.search(t,new s.MemberPtr(e.value,"right"),r),r}_getInorderSuccessor(t,e=new s.MemberPtr(this,"bst_root")){let r;const n=t=>{(!r||t&&this.gtcmp(r.data,t.data))&&(r=t)};return e.value&&(this.gteqcmp(e.value.data,t)&&(this.eqcmp(e.value.data,t)||n({ptr:e,data:e.value.data}),n(this._getInorderSuccessor(t,new s.MemberPtr(e.value,"left")))),n(this._getInorderSuccessor(t,new s.MemberPtr(e.value,"right")))),r}remove(t,e=(()=>!0),r=new s.MemberPtr(this,"bst_root")){if(r.value){const n=this.cmp(r.value.data,t),o=e(r.value.data);if(n>0)this.remove(t,e,new s.MemberPtr(r.value,"left"));else if(n<0)this.remove(t,e,new s.MemberPtr(r.value,"right"));else if(r.value.left&&r.value.right&&o){const t=this._getInorderSuccessor(r.value.data,r);this.remove(t.data,void 0,t.ptr),r.value.data=t.data}else o&&(r.value=r.value.left||r.value.right)}}operateOnAllRange(t,e,r,s=this.bst_root,n=!1){s&&!n&&(this.gteqcmp(s.data,t)?this.gteqcmp(e,s.data)?(this.operateOnAllRange(t,e,r,s.left,!s.left),this.operateOnAllRange(t,e,r,s.right,!s.right),r(s)):this.operateOnAllRange(t,e,r,s.left,!s.left):this.operateOnAllRange(t,e,r,s.right,!s.right))}operateOnAllGteq(t,e,r=new s.MemberPtr(this,"bst_root")){r.value&&(this.gteqcmp(r.value.data,t)&&(e(r.value),this.operateOnAllGteq(t,e,new s.MemberPtr(r.value,"left"))),this.operateOnAllGteq(t,e,new s.MemberPtr(r.value,"right")))}operateOnAllLteq(t,e,r=new s.MemberPtr(this,"bst_root")){r.value&&(this.gteqcmp(t,r.value.data)&&(e(r.value),this.operateOnAllLteq(t,e,new s.MemberPtr(r.value,"right"))),this.operateOnAllLteq(t,e,new s.MemberPtr(r.value,"left")))}operateOnAll(t,e=new s.MemberPtr(this,"bst_root")){e.value&&(this.operateOnAll(t,new s.MemberPtr(e.value,"left")),t(e.value),this.operateOnAll(t,new s.MemberPtr(e.value,"right")))}getRange(t,e){const r=[];return this.operateOnAllRange(t,e,t=>r.push(t)),r}getGteq(t){let e=[];return this.operateOnAllGteq(t,t=>{!e[0]||this.gtcmp(e[0].data,t.data)?e=[t]:this.eqcmp(e[0].data,t.data)&&e.push(t)}),e}getLteq(t){let e=[];return this.operateOnAllLteq(t,t=>{!e[0]||this.gtcmp(t.data,e[0].data)?e=[t]:this.eqcmp(e[0].data,t.data)&&e.push(t)}),e}toString(){let t="BST [\n";return this.operateOnAll(({data:e})=>{t+="  "+e.toString().split("\n").join("\n  ")+"\n"}),t+="]",t}}},function(t,e,r){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const s=r(5),n=r(0);var o,i=s.Int32;e.LogootInt=i;class a{constructor(t=0,e,r){if(this.start=e,this.end=r,this.array=[new i(0)],!e&&r)this.array=r.inverseOffsetLowest(t).array;else if(!r&&e)this.array=e.copy().array;else if(e&&r){let s=!1;const n=e.array.values(),o=r.array.values();let a,h;for(this.array.length=0;!s;)a&&a.done||(a=n.next()),h&&h.done||(h=o.next()),a.done||h.done?a.done?h.done?(this.array.push(new i),s=!0):(this.array.push(new i(h.value).sub(t)),s=!0):(this.array.push(new i(a.value)),s=!0):(h.value.gteq(new i(a.value).add(t))&&(s=!0),this.array.push(new i(a.value)))}}static fromJSON(t){const e=new a;return e.array.length=0,t.forEach(t=>{e.array.push(i.fromJSON(t))}),e}static fromInts(...t){const e=new a;return e.array.length=0,t.forEach(t=>{e.array.push(new i(t))}),e}toJSON(){return this.array.map(t=>t.toJSON())}get length(){return this.array.length}get levels(){return this.length-1}level(t){return this.array[t]}l(t){return this.level(t)}offsetLowest(t){return Object.assign(new a,{array:this.array.map((e,r,s)=>r<s.length-1?e:new i(e).add(t))})}inverseOffsetLowest(t){return Object.assign(new a,{array:this.array.map((e,r,s)=>r<s.length-1?e:new i(e).sub(t))})}copy(){return Object.assign(new a,{array:this.array.map(t=>new i(t))})}equivalentPositionAtLevel(t){return Object.assign(new a,{array:new Array(t+1).fill(0,0,t+1).map((t,e)=>new i(this.array[e]))})}cmp(t,e=0){if(e>=this.length)return this.length===t.length?0:1;if(e>=t.length)return-1;switch(this.level(e).cmp(t.level(e))){case 1:return 1;case-1:return-1;case 0:return this.cmp(t,e+1);default:return 0}}clamp(t,e,r){const s=this.cmp(t)<0?t:this.cmp(e)>0?e:this;return void 0!==r?s.equivalentPositionAtLevel(r):s.copy()}toString(){let t="[";return this.array.forEach((e,r,s)=>{t+=e.toString()+(r>=s.length-1?"":",")}),t+="]",t}}e.LogootPosition=a,function(t){let e;!function(t){t.Schema={type:"array",items:i.JSON.Schema}}(e=t.JSON||(t.JSON={}))}(a||(a={})),e.LogootPosition=a,function(t){t[t.DATA=0]="DATA",t[t.REMOVAL=1]="REMOVAL"}(o||(o={})),e.NodeType=o;const h={[o.DATA]:"DATA",[o.REMOVAL]:"REMOVAL"};e.ConflictGroup=class{constructor(t){this.known_position=0,this.branch_order=[],this.groups=[],this.known_position=t}get ldoc_length(){return this.groups.reduce((t,e)=>t+e.ldoc_length,0)}get ldoc_end(){return this.known_position+this.ldoc_length}get logoot_start(){return this.groups[0]?this.groups[0].start:void 0}get logoot_end(){return this.groups.length?this.groups[this.groups.length-1].end:void 0}get first_branch(){return this.branch_order[0]}get last_branch(){return this.branch_order.length?this.branch_order[this.branch_order.length-1]:void 0}get conflicted(){return this.groups.some(t=>t.conflicted)}branchLength(t){return this.groups.reduce((e,r)=>e+r.branchLength(t),0)}insertPos(t,e){let r=this.known_position+this.branchLength(this.branch_order.slice(0,this.branch_order.indexOf(t)+(e?0:1)));if(!e)return r;for(let s=0;s<this.groups.length;s++){if(this.groups[s]===e)return r;r+=this.groups[s].branchLength([t])}throw new n.FatalError("Tried to insert after a LogootNodeGroup that is not in this conflict group")}getNeighbors({start:t}){let e;for(let r=0;r<this.groups.length;r++)if(this.groups[r].start.cmp(t)<=0&&(e=this.groups[r]),this.groups[r].start.cmp(t)>0)return{left:e,right:this.groups[r],pos:r};return{left:e,right:void 0,pos:this.groups.length}}insertSingleBranchGroup(t){if(1!==t.n_branches)throw new TypeError("Passed group with no or more than one branch");if(t.group!==this)throw new TypeError("Conflict group not assigned to node group");const e=t.branches[0];this.branch_order.includes(e)||this.branch_order.push(e);const{right:r,pos:s}=this.getNeighbors(t),n=this.insertPos(e,r);return this.groups.splice(s,0,t),n}toString(){let t=`Conflict @ ${this.known_position} (`;return t+=this.branch_order.map(t=>t.toString()).join(" "),t+=") {",t+=this.groups.map(t=>"\n  "+t.toString().split("\n").join("\n  ")),t+="\n}",t}};class l{constructor(t){this.length=0,this.start=new a,this.nodes={},t&&(Object.assign(this,{length:t.length,start:t.start.copy(),group:t.group}),t.eachNode(({type:t,rclk:e},r)=>{this.br(r,{type:t,rclk:new i(e)})}))}get ldoc_length(){return this.branches.reduce((t,e)=>this.br(e).type===o.DATA?t+this.length:t,0)}branchLength(t){return this.branches.filter(e=>t.includes(e)).reduce((t,e)=>this.br(e).type===o.DATA?t+this.length:t,0)}get end(){return this.start.offsetLowest(this.length)}get branches(){return n.allKeys(this.nodes)}get n_branches(){return this.branches.length}get conflicted(){return this.n_branches>1}eachNode(t){this.branches.forEach(e=>{t(this.br(e),e)})}mapNodes(t){const e={};return this.branches.forEach(r=>{e[r]=t(this.br(r),r)}),e}br(t,e){return e&&(this.nodes[t]=e),this.nodes[t]}delBr(t){delete this.nodes[t]}splitAround(t){const e=new l(this);e.start=this.start.offsetLowest(t),e.length=this.length-t;const r=e.group.groups;return r.splice(r.indexOf(this)+1,0,e),this.length=t,e}toString(){let t=`Group ${this.start.toString()} + ${this.length} {`;return t+=this.branches.map(t=>{const e=this.br(t);return`\n  ${String(t)}: ${h[e.type]} @ ${e.rclk.toString()}`}),t+="\n}",t}}e.LogootNodeGroup=l},function(t,e,r){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const s=r(0);class n extends s.Comparable{}e.IntType=n;class o extends n{constructor(t=0){super(),this.int32=new Int32Array([0]),this.int32[0]=t instanceof o?t.int32[0]:t}static fromJSON(t){return new o(t)}toJSON(){return this.int32[0]}add(t){return this.int32[0]+=t instanceof o?t.int32[0]:t,this}sub(t){return this.int32[0]-=t instanceof o?t.int32[0]:t,this}assign(t){return this.int32[0]=t instanceof o?t.int32[0]:t,this}cmp(t){return t instanceof o?(this.int32[0]>=t.int32[0]?1:0)+(this.int32[0]<=t.int32[0]?-1:0):(this.int32[0]>=t?1:0)+(this.int32[0]<=t?-1:0)}copy(){return new o(this)}get js_int(){return this.int32[0]}toString(){return this.int32[0].toString()}}e.Int32=o,function(t){let e;!function(t){t.Schema={type:"number"}}(e=t.JSON||(t.JSON={}))}(o||(o={})),e.Int32=o}])}));
//# sourceMappingURL=logootish-js.min.js.map